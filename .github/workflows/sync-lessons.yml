name: Sync Lessons to LabEx

on:
  push:
    branches: [master]
    paths:
      - "lessons/**/*.md"
  pull_request:
    branches: [master]
    paths:
      - "lessons/**/*.md"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      sync_path:
        description: "æŒ‡å®šè¦åŒæ­¥çš„æ–‡æ¡£è·¯å¾„ (ä¾‹å¦‚ï¼šlessons/en/logging/syslog.md)ï¼Œç•™ç©ºåˆ™åŒæ­¥æ‰€æœ‰å˜æ›´æ–‡æ¡£"
        required: false
        default: ""
        type: string

jobs:
  sync-lessons:
    name: Sync LabEx Lessons
    runs-on: ubuntu-latest

    env:
      LABEX_USERNAME: ${{ secrets.LABEX_USERNAME }}
      LABEX_PASSWORD: ${{ secrets.LABEX_PASSWORD }}
      WORKSPACE: ${{ github.workspace }}

    steps:
      - name: Clean workspace
        run: |
          mkdir -p $WORKSPACE
          rm -rf "$WORKSPACE/labex-auto"
          echo "å·¥ä½œç›®å½•å·²æ¸…ç†å®Œæˆ"
          ls -la $WORKSPACE

      - name: Checkout labex-auto
        uses: actions/checkout@v4
        with:
          repository: labex-labs/labex-auto
          path: labex-auto

      - name: Checkout linuxjourney (for getting changed files)
        uses: actions/checkout@v4
        with:
          path: linuxjourney

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          cd labex-auto
          pip install -e .

      - name: Verify environment variables
        run: |
          for var in LABEX_USERNAME LABEX_PASSWORD; do
            if [ -z "${!var}" ]; then
              echo "é”™è¯¯: ç¼ºå°‘ç¯å¢ƒå˜é‡ $var"
              exit 1
            fi
          done
          echo "æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡å·²è®¾ç½®"

      - name: Get changed lesson files
        id: changed-files
        run: |
          cd linuxjourney

          # è·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # å¯¹äº push äº‹ä»¶ï¼Œæ¯”è¾ƒå½“å‰æäº¤å’Œå‰ä¸€ä¸ªæäº¤
            CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD -- 'lessons/**/*.md' | tr '\n' ' ')
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # å¯¹äº PR äº‹ä»¶ï¼Œæ¯”è¾ƒç›®æ ‡åˆ†æ”¯å’Œæºåˆ†æ”¯
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD -- 'lessons/**/*.md' | tr '\n' ' ')
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && [[ -n "${{ github.event.inputs.sync_path }}" ]]; then
            # å¯¹äºæ‰‹åŠ¨è§¦å‘ä¸”æŒ‡å®šäº†è·¯å¾„ï¼Œç›´æ¥ä½¿ç”¨æŒ‡å®šè·¯å¾„
            SYNC_PATH="${{ github.event.inputs.sync_path }}"
            if [[ -f "$SYNC_PATH" ]] && [[ "$SYNC_PATH" =~ ^lessons/.*\.md$ ]]; then
              CHANGED_FILES="$SYNC_PATH"
            else
              echo "é”™è¯¯: æŒ‡å®šè·¯å¾„ä¸å­˜åœ¨æˆ–ä¸æ˜¯æœ‰æ•ˆçš„ lessons æ–‡æ¡£ï¼š$SYNC_PATH"
              echo "è·¯å¾„åº”è¯¥ä»¥ 'lessons/' å¼€å¤´å¹¶ä»¥ '.md' ç»“å°¾"
              exit 1
            fi
          else
            # å¯¹äºæ‰‹åŠ¨è§¦å‘ä¸”æœªæŒ‡å®šè·¯å¾„ï¼Œè·å–æ‰€æœ‰ lessons ä¸‹çš„ md æ–‡ä»¶
            CHANGED_FILES=$(find lessons -name "*.md" | tr '\n' ' ')
          fi

          echo "å˜æ›´çš„æ–‡æ¡£æ–‡ä»¶: $CHANGED_FILES"
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Sync changed lessons to LabEx
        run: |
          cd labex-auto

          # è·å–å˜æ›´æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"

          if [ -z "$CHANGED_FILES" ]; then
            echo "æ²¡æœ‰å˜æ›´çš„æ–‡æ¡£æ–‡ä»¶ï¼Œè·³è¿‡åŒæ­¥"
            exit 0
          fi

          echo "å¼€å§‹åŒæ­¥å˜æ›´çš„æ–‡æ¡£åˆ° LabEx..."
          echo "æ‰§è¡Œæ—¶é—´: $(date)"

          # å¯¹æ¯ä¸ªå˜æ›´çš„æ–‡æ¡£æ‰§è¡ŒåŒæ­¥
          SYNC_COUNT=0
          FAILED_FILES=""
          SUCCESS_FILES=""

          for file in $CHANGED_FILES; do
            if [ -f "../linuxjourney/$file" ]; then
              echo "åŒæ­¥æ–‡æ¡£: $file"
              if labex-auto labex sync linuxjourney --path "$file"; then
                SUCCESS_FILES="$SUCCESS_FILES\n- âœ… $file"
                SYNC_COUNT=$((SYNC_COUNT + 1))
              else
                FAILED_FILES="$FAILED_FILES\n- âŒ $file"
              fi
            fi
          done

          # ä¿å­˜åŒæ­¥ç»“æœåˆ°è¾“å‡º
          echo "sync_count=$SYNC_COUNT" >> $GITHUB_OUTPUT
          echo "success_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$SUCCESS_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "failed_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FAILED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate sync summary
        run: |
          SYNC_COUNT="${{ steps.sync-lessons.outputs.sync_count }}"
          SUCCESS_FILES="${{ steps.sync-lessons.outputs.success_files }}"
          FAILED_FILES="${{ steps.sync-lessons.outputs.failed_files }}"
          CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"

          # ç”Ÿæˆ GitHub Actions summary
          {
            echo "## ğŸ“š LabEx æ–‡æ¡£åŒæ­¥æŠ¥å‘Š"
            echo ""
            echo "### ğŸ“Š åŒæ­¥ç»Ÿè®¡"
            echo "- **åŒæ­¥æ–‡æ¡£æ•°é‡**: $SYNC_COUNT"
            echo "- **è§¦å‘ç±»å‹**: ${{ github.event_name }}"
            echo "- **æ‰§è¡Œæ—¶é—´**: $(date)"
            echo ""

            if [ -n "$CHANGED_FILES" ]; then
              echo "### ğŸ“‹ æ£€æµ‹åˆ°çš„å˜æ›´æ–‡ä»¶"
              for file in $CHANGED_FILES; do
                echo "- ğŸ“„ $file"
              done
              echo ""
            fi

            if [ -n "$SUCCESS_FILES" ]; then
              echo "### âœ… åŒæ­¥æˆåŠŸçš„æ–‡ä»¶"
              echo "$SUCCESS_FILES"
              echo ""
            fi

            if [ -n "$FAILED_FILES" ]; then
              echo "### âŒ åŒæ­¥å¤±è´¥çš„æ–‡ä»¶"
              echo "$FAILED_FILES"
              echo ""
            fi

            echo "### ğŸ”— ç›¸å…³é“¾æ¥"
            echo "- [æŸ¥çœ‹æœ¬æ¬¡æäº¤](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})"
            echo "- [æŸ¥çœ‹ Actions æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo ""

            if [ -n "$FAILED_FILES" ]; then
              echo "âš ï¸  **æ³¨æ„**: éƒ¨åˆ†æ–‡ä»¶åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°å¤±è´¥æ–‡ä»¶åˆ—è¡¨ã€‚"
            else
              echo "ğŸ‰ **åŒæ­¥å®Œæˆ**: æ‰€æœ‰æ£€æµ‹åˆ°çš„æ–‡æ¡£å·²æˆåŠŸåŒæ­¥åˆ° LabExï¼"
            fi
          } >> $GITHUB_STEP_SUMMARY

      - name: Notify completion
        run: |
          echo "æ–‡æ¡£åŒæ­¥ä»»åŠ¡å®Œæˆ"
          echo "å®Œæˆæ—¶é—´: $(date)"
